# Runbook

> Generated by Claude Code V7.7 - DevOps Skill

## Health Checks

| Endpoint             | Expected                     | Action if Failed                    |
| -------------------- | ---------------------------- | ----------------------------------- |
| `GET /api/health`    | `200 {"status":"healthy"}`   | Check logs, restart if needed       |
| `GET /api/health/db` | `200 {"status":"connected"}` | Check DATABASE_URL, verify DB is up |
| `GET /`              | `200 HTML`                   | Check build, redeploy if needed     |

## Common Incidents

### 1. Application Not Responding

**Symptoms:**

- Health check returns 5xx
- Requests timing out
- Users report "page not loading"

**Diagnosis:**

```bash
# Check application logs (Vercel)
vercel logs [deployment-url] --follow

# Check memory/CPU (if self-hosted)
htop
```

**Resolution:**

1. Check logs for errors
2. Verify environment variables are set
3. Check if recent deploy introduced issue
4. Rollback if needed: `vercel rollback`
5. Restart if self-hosted

**Prevention:**

- Monitor error rate alerts
- Set up auto-restart on failure
- Test deploys in staging first

---

### 2. Database Connection Failed

**Symptoms:**

- API returns 500 errors
- Logs show "connection timeout" or "ECONNREFUSED"
- Health check `/api/health/db` fails

**Diagnosis:**

```bash
# Verify DATABASE_URL is set
vercel env pull

# Test database connection manually
psql $DATABASE_URL -c "SELECT 1"

# Check connection count
psql $DATABASE_URL -c "SELECT count(*) FROM pg_stat_activity"
```

**Resolution:**

1. Verify DATABASE_URL environment variable
2. Check database service status in provider dashboard
3. Verify network/firewall rules allow connection
4. Check connection pool limits (max ~20 for serverless)
5. Restart database if needed

**Prevention:**

- Set up database monitoring
- Configure connection pool limits
- Use connection pooler (PgBouncer) for serverless

---

### 3. Stripe Integration Failing

**Symptoms:**

- Billing page not loading
- "Unable to load payment methods" error
- Checkout button not working

**Diagnosis:**

```bash
# Check Stripe API status
curl https://status.stripe.com/api/v2/status.json

# Verify Stripe keys are set
vercel env ls | grep STRIPE

# Check Stripe dashboard for failed requests
# https://dashboard.stripe.com/test/developers
```

**Resolution:**

1. Verify STRIPE_SECRET_KEY and STRIPE_PUBLISHABLE_KEY
2. Check Stripe API status page
3. Verify webhook endpoint is configured
4. Check webhook signing secret matches
5. Test in Stripe test mode first

---

### 4. High Error Rate

**Symptoms:**

- Error tracking shows spike
- Users reporting failures
- 5xx response rate increasing

**Diagnosis:**

```bash
# Check error logs
vercel logs [deployment-url] --output json | grep error

# Check recent deployments
vercel ls

# Check recent commits
git log --oneline -10
```

**Resolution:**

1. Identify error pattern in logs
2. Check if recent deploy introduced issue
3. Rollback if needed: `vercel rollback`
4. Hot-fix if simple issue
5. Investigate root cause

---

### 5. Slow Response Times

**Symptoms:**

- Users report slow loading
- Monitoring shows increased latency
- Lighthouse scores dropped

**Diagnosis:**

```bash
# Check Vercel analytics
# https://vercel.com/[org]/[project]/analytics

# Test response time
time curl -o /dev/null -s https://billing.example.com/dashboard

# Check for N+1 queries in logs
```

**Resolution:**

1. Check database query times
2. Verify CDN is caching static assets
3. Check for memory leaks
4. Review recent code changes
5. Add caching if needed

---

## Escalation

| Severity     | Response Time     | Contact             | Examples             |
| ------------ | ----------------- | ------------------- | -------------------- |
| **Critical** | 15 min            | PagerDuty â†’ On-call | Site down, data loss |
| **High**     | 1 hour            | Slack #incidents    | Major feature broken |
| **Medium**   | 4 hours           | Slack #engineering  | Degraded performance |
| **Low**      | Next business day | GitHub issue        | Minor bug            |

## Useful Commands

```bash
# View application logs
vercel logs [deployment-url]

# View recent deployments
vercel ls

# Rollback to previous deployment
vercel rollback

# Force re-deploy current
vercel --force

# Pull production env vars
vercel env pull .env.local

# Check build output
vercel inspect [deployment-url]
```

## Database Commands

```bash
# Connect to production database (use with caution)
psql $DATABASE_URL

# Run migrations
npx prisma migrate deploy

# Check pending migrations
npx prisma migrate status

# Generate Prisma client
npx prisma generate
```

---

_Last updated: 2024-12-23_
