# API Contracts

> Generated by Claude Code V7.7

## Base URL

- Development: `http://localhost:3000/api`
- Production: `${NEXT_PUBLIC_APP_URL}/api`

## Authentication

All protected endpoints require a valid Supabase session. Authentication is handled via HTTP-only cookies managed by Supabase SSR.

**Headers:**

```
Cookie: sb-access-token=...; sb-refresh-token=...
```

## Standard Response Format

```typescript
// Success
{ data: T, meta?: { page: number, total: number } }

// Error
{ error: string, code?: string }
```

## Error Codes

| Code               | HTTP Status | Description             |
| ------------------ | ----------- | ----------------------- |
| `VALIDATION_ERROR` | 400         | Input validation failed |
| `UNAUTHORIZED`     | 401         | Authentication required |
| `FORBIDDEN`        | 403         | Permission denied       |
| `NOT_FOUND`        | 404         | Resource not found      |
| `RATE_LIMITED`     | 429         | Too many requests       |
| `SERVER_ERROR`     | 500         | Internal error          |

---

## Endpoints

### POST /api/checkout

Create a Stripe Checkout session for subscription.

**Authentication:** Required

**Request Body:**

```json
{
  "priceId": "price_xxxxx"
}
```

**Response:**

```json
{
  "url": "https://checkout.stripe.com/c/pay/..."
}
```

**Errors:**

- 400: Invalid or missing price ID
- 401: Not authenticated
- 500: Stripe configuration error

---

### POST /api/billing/portal

Create a Stripe Customer Portal session.

**Authentication:** Required

**Request Body:**

```json
{
  "customerId": "cus_xxxxx"
}
```

**Response:**

```json
{
  "url": "https://billing.stripe.com/session/..."
}
```

**Errors:**

- 400: Missing customer ID
- 401: Not authenticated
- 500: Portal creation failed

---

### POST /api/webhooks/stripe

Stripe webhook endpoint for subscription lifecycle events.

**Authentication:** Stripe signature verification

**Headers:**

```
stripe-signature: t=...,v1=...,v0=...
```

**Handled Events:**
| Event | Description |
|-------|-------------|
| `checkout.session.completed` | New subscription created |
| `invoice.paid` | Invoice payment successful |
| `invoice.payment_failed` | Invoice payment failed |
| `customer.subscription.updated` | Subscription status changed |
| `customer.subscription.deleted` | Subscription canceled |

**Response:**

```json
{ "received": true }
```

---

### GET /api/plans

List all available subscription plans.

**Authentication:** Not required (public endpoint)

**Response:**

```json
{
  "data": [
    {
      "id": "plan_starter",
      "name": "Starter",
      "description": "Perfect for small businesses",
      "price_cents": 900,
      "currency": "usd",
      "interval": "month",
      "stripe_price_id": "price_starter_monthly",
      "features": ["Up to 5 team members", "Basic analytics", "Email support"],
      "is_active": true
    }
  ]
}
```

**Notes:**

- Only returns active plans (is_active = true)
- Plans are sorted by price ascending

---

### POST /api/subscriptions/change

Change subscription to a different plan (upgrade/downgrade).

**Authentication:** Required

**Request Body:**

```json
{
  "priceId": "price_pro_monthly",
  "subscriptionId": "sub_xxxxx"
}
```

| Field          | Type   | Required | Description                                     |
| -------------- | ------ | -------- | ----------------------------------------------- |
| priceId        | string | Yes      | Stripe Price ID for the new plan                |
| subscriptionId | string | No       | Existing subscription ID (if null, creates new) |

**Response (new subscription):**

```json
{
  "url": "https://checkout.stripe.com/c/pay/..."
}
```

**Response (plan change):**

```json
{
  "data": {
    "subscriptionId": "sub_xxxxx",
    "status": "active",
    "currentPeriodEnd": "2024-02-01T00:00:00Z"
  }
}
```

**Errors:**

- 400: Missing or invalid price ID
- 401: Not authenticated
- 404: Subscription not found
- 500: Failed to change subscription

**Notes:**

- Prorated billing applied immediately (always_invoice)
- If no subscriptionId provided, redirects to Stripe Checkout

---

## Third-Party Integrations

### Stripe

**SDK Version:** 20.1.0 (from package.json)
**Documentation:** https://stripe.com/docs/api

**API Version:** 2025-12-15.clover

**Endpoints Used:**
| Endpoint | Purpose |
|----------|---------|
| `checkout.sessions.create` | Create checkout session for new subscriptions |
| `billingPortal.sessions.create` | Create customer portal for managing subscriptions |
| `webhooks.constructEvent` | Verify webhook signatures |

**Webhooks:**
| Event | Handler Location |
|-------|------------------|
| `checkout.session.completed` | `src/app/api/webhooks/stripe/route.ts` |
| `invoice.paid` | `src/app/api/webhooks/stripe/route.ts` |
| `invoice.payment_failed` | `src/app/api/webhooks/stripe/route.ts` |
| `customer.subscription.updated` | `src/app/api/webhooks/stripe/route.ts` |
| `customer.subscription.deleted` | `src/app/api/webhooks/stripe/route.ts` |

**Environment Variables:**
| Variable | Description |
|----------|-------------|
| `STRIPE_SECRET_KEY` | Server-side API key (sk*test*... or sk*live*...) |
| `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` | Client-side key (pk*test*... or pk*live*...) |
| `STRIPE_WEBHOOK_SECRET` | Webhook signing secret (whsec\_...) |

**Rate Limits:**

- 100 requests/second in test mode
- 100 requests/second in live mode (can be increased)

**Error Handling:**

- All Stripe errors are caught and logged
- User-friendly error messages returned
- Webhook failures return 400/500 status codes

**Security:**

- [x] Secret key never exposed to client
- [x] Webhook signature verification
- [x] User ID stored in metadata for tracing
- [x] HTTPS only in production

---

### Supabase

**SDK Version:** 2.89.0 (from package.json)
**Documentation:** https://supabase.com/docs

**Clients:**
| Client | Location | Purpose |
|--------|----------|---------|
| Browser Client | `src/lib/supabase/client.ts` | Client-side auth/data |
| Server Client | `src/lib/supabase/server.ts` | Server components/actions |
| Middleware Client | `src/lib/supabase/middleware.ts` | Route protection |

**Endpoints Used:**
| Method | Purpose |
|--------|---------|
| `auth.signUp` | User registration |
| `auth.signInWithPassword` | User login |
| `auth.signOut` | User logout |
| `auth.getUser` | Get current user |
| `auth.exchangeCodeForSession` | OAuth callback |

**Environment Variables:**
| Variable | Description |
|----------|-------------|
| `NEXT_PUBLIC_SUPABASE_URL` | Project URL |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Public anon key |
| `SUPABASE_SERVICE_ROLE_KEY` | Service role key (server only) |

---

_Last updated: 2024-12-23_
