# Performance Audit: Billing Dashboard

> Generated by Performance Skill on 2024-12-23

## Core Web Vitals Targets

| Metric                         | Target  | Current | Status |
| ------------------------------ | ------- | ------- | ------ |
| LCP (Largest Contentful Paint) | < 2.5s  | TBD     | -      |
| FID (First Input Delay)        | < 100ms | TBD     | -      |
| CLS (Cumulative Layout Shift)  | < 0.1   | TBD     | -      |
| TTFB (Time to First Byte)      | < 600ms | TBD     | -      |

## Bundle Size Analysis

### Size Targets

| Chunk                 | Target          | Current           | Status  |
| --------------------- | --------------- | ----------------- | ------- |
| Initial JS            | < 100KB gzipped | ~85KB (estimated) | ✅ Good |
| Per-route (dashboard) | < 50KB gzipped  | ~30KB (estimated) | ✅ Good |
| Total CSS             | < 50KB gzipped  | ~15KB (estimated) | ✅ Good |

### Bundle Composition (Estimated)

```
Total: ~130KB gzipped

├── react + react-dom: ~45KB
├── next.js framework: ~25KB
├── @stripe/stripe-js: ~40KB (lazy loadable)
├── Application code: ~15KB
└── CSS: ~5KB
```

### Recommendations

1. **Lazy load Stripe.js** - Only load on billing pages
2. **Tree-shake unused components** - Verify imports are specific

## N+1 Query Analysis

### Checked Areas

| Area                    | Status   | Notes                   |
| ----------------------- | -------- | ----------------------- |
| User subscription fetch | ✅ OK    | Single query            |
| Plan data               | ✅ OK    | Static data, no query   |
| Usage metrics           | ✅ OK    | Single aggregated query |
| Team members            | ⚠️ Check | May need batching       |

### Potential N+1 in Team Members

```typescript
// ❌ Current (potential N+1)
const users = await getTeamMembers(teamId);
for (const user of users) {
  user.lastActivity = await getLastActivity(user.id);
}

// ✅ Recommended (batch)
const users = await getTeamMembers(teamId);
const activities = await getLastActivities(users.map((u) => u.id));
users.forEach((u) => (u.lastActivity = activities[u.id]));
```

## Caching Strategy

| Resource                | Strategy                              | Rationale                   |
| ----------------------- | ------------------------------------- | --------------------------- |
| Static assets (JS/CSS)  | `max-age=31536000, immutable`         | Fingerprinted filenames     |
| API: /api/plans         | `s-maxage=3600`                       | Plans change rarely         |
| API: /api/usage-metrics | `s-maxage=60, stale-while-revalidate` | Fresh but cacheable         |
| API: /api/subscription  | `no-store`                            | User-specific, always fresh |
| Images                  | `max-age=86400`                       | Logos, icons                |

## Quick Wins Checklist

- [x] **Gzip/Brotli compression** - Enabled by Next.js
- [x] **CDN for static assets** - Vercel Edge Network
- [ ] **Lazy load below-the-fold images** - Add to team member avatars
- [x] **Remove unused CSS/JS** - Tree-shaking enabled
- [ ] **Resource hints** - Add preconnect for Stripe
- [x] **Font-display: swap** - Prevents FOIT
- [ ] **Defer non-critical scripts** - Move analytics to defer

### Preconnect Recommendations

```html
<!-- Add to _document.tsx or layout.tsx -->
<link rel="preconnect" href="https://js.stripe.com" />
<link rel="preconnect" href="https://api.stripe.com" />
<link rel="dns-prefetch" href="https://plausible.io" />
```

## Performance Optimizations Applied

### 1. UsageMetrics Component

```typescript
// Skeleton loading prevents CLS
function LoadingSkeleton() {
  return <div className="usage-metrics--loading" />;
}

// Fixed dimensions prevent layout shift
const MetricCard = styled.div`
  width: 100%;
  min-height: 120px; /* Prevents CLS */
`;
```

### 2. Code Splitting

```typescript
// Stripe Customer Portal loaded on demand
const StripePortal = lazy(() => import("./StripePortal"));
```

### 3. Optimized Images

```typescript
// Next.js Image with blur placeholder
<Image
  src="/logo.png"
  alt="Logo"
  width={150}
  height={40}
  priority
  placeholder="blur"
  blurDataURL={blurDataUrl}
/>
```

## Before/After Template

| Metric           | Before | After | Improvement |
| ---------------- | ------ | ----- | ----------- |
| LCP              | -      | -     | -           |
| FID              | -      | -     | -           |
| CLS              | -      | -     | -           |
| Bundle Size      | -      | -     | -           |
| Lighthouse Score | -      | -     | -           |

---

## Exit Criteria Status

- [x] Core Web Vitals targets documented
- [x] Bundle size within targets (estimated)
- [x] N+1 query patterns identified
- [x] Caching strategy defined
- [ ] Before/after measurements (pending production deployment)

---

_Audit generated: 2024-12-23_
_Next review: Before production launch_
