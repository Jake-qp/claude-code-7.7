# Deployment Guide

> Generated by Claude Code V7.7 - DevOps Skill

## Environments

| Environment | URL                                 | Branch      | Auto-Deploy |
| ----------- | ----------------------------------- | ----------- | ----------- |
| Production  | https://billing.example.com         | main        | Yes         |
| Staging     | https://staging.billing.example.com | develop     | Yes         |
| Preview     | Auto-generated per PR               | PR branches | Yes         |

## Prerequisites

- [ ] Node.js 20.x
- [ ] npm 10.x
- [ ] Vercel CLI (`npm i -g vercel`)
- [ ] Access to Vercel project

## Environment Variables

| Variable                 | Required | Description                     | Example                               |
| ------------------------ | -------- | ------------------------------- | ------------------------------------- |
| `DATABASE_URL`           | Yes      | PostgreSQL connection string    | `postgresql://user:pass@host:5432/db` |
| `NEXTAUTH_SECRET`        | Yes      | Auth encryption key (32+ chars) | `openssl rand -base64 32`             |
| `NEXTAUTH_URL`           | Yes      | Application base URL            | `https://billing.example.com`         |
| `STRIPE_SECRET_KEY`      | Yes      | Stripe secret key               | `sk_live_...`                         |
| `STRIPE_PUBLISHABLE_KEY` | Yes      | Stripe publishable key          | `pk_live_...`                         |
| `STRIPE_WEBHOOK_SECRET`  | Yes      | Stripe webhook signing secret   | `whsec_...`                           |
| `PLAUSIBLE_DOMAIN`       | No       | Plausible analytics domain      | `billing.example.com`                 |

## CI/CD Pipeline

Pipeline runs on every push and pull request:

```
lint → test → e2e → build → deploy
```

| Stage             | Trigger         | Duration |
| ----------------- | --------------- | -------- |
| Lint              | All pushes      | ~30s     |
| Unit Tests        | All pushes      | ~2min    |
| E2E Tests         | All pushes      | ~5min    |
| Build             | After lint+test | ~2min    |
| Deploy Preview    | PRs only        | ~1min    |
| Deploy Production | main branch     | ~1min    |

## Deploy to Staging

Automatic on push to `develop` branch.

Manual deployment:

```bash
# Pull latest
git checkout develop
git pull origin develop

# Deploy to staging
vercel --env production=false

# Verify deployment
curl https://staging.billing.example.com/api/health
```

## Deploy to Production

Automatic on push to `main` branch.

Manual deployment:

```bash
# Ensure on main
git checkout main
git pull origin main

# Deploy to production
vercel --prod

# Verify deployment
curl https://billing.example.com/api/health
```

## Rollback Procedure

### Immediate Rollback (< 5 minutes)

```bash
# List recent deployments
vercel ls

# Rollback to previous deployment
vercel rollback [deployment-url]

# Verify rollback
curl https://billing.example.com/api/health
```

### Git-based Rollback

```bash
# Find last working commit
git log --oneline -10

# Revert to that commit
git revert HEAD~N..HEAD

# Push to trigger new deploy
git push origin main
```

## Post-Deployment Checks

- [ ] Health endpoint responding: `GET /api/health` returns 200
- [ ] Database connection working: Check in health response
- [ ] Authentication working: Test login flow
- [ ] Stripe integration working: Test billing page loads
- [ ] SSL certificate valid: Check browser padlock
- [ ] Monitoring alerts active: Check dashboard

## Deployment Checklist

### Before Deploy

- [ ] All tests passing in CI
- [ ] PR reviewed and approved
- [ ] No pending database migrations (or run them first)
- [ ] Environment variables updated if needed
- [ ] Stripe webhooks configured for new domain

### After Deploy

- [ ] Health check passes
- [ ] Smoke test critical paths manually
- [ ] Check error tracking for new errors
- [ ] Monitor metrics for anomalies
- [ ] Announce deployment in team channel

## Secrets Management

| Secret               | Storage        | Rotation                          |
| -------------------- | -------------- | --------------------------------- |
| Database credentials | Vercel/Railway | Quarterly                         |
| Stripe keys          | Vercel         | Never (use restricted keys)       |
| Auth secret          | Vercel         | Never (would invalidate sessions) |

**Never commit secrets to the repository.**

---

_Last updated: 2024-12-23_
